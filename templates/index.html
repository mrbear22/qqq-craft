<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QQQ - –ß–∞—Å —Å—Ç–∞—Ç–∏ –ª–µ–≥–µ–Ω–¥–æ—é!</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
	<link rel="icon" href="{{ url_for('static', filename='logo.ico') }}">
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
</head>
<body>
	<div class="container">
		<div class="news">
			<div id="news-list">
				{% if news %}
					<h1>–ù–æ–≤–∏–Ω–∏</h1>
					{% for news_item in news %}
						<div class="new">
							{% if news_item.image %}
								<div class="news-image">
									<img src="{{ news_item.image }}" alt="–ó–æ–±—Ä–∞–∂–µ–Ω–Ω—è –¥–ª—è –Ω–æ–≤–∏–Ω–∏">
								</div>
							{% endif %}
							<div class="news-content">
								{% if news_item.title %}
									<strong class="news-title">{{ news_item.title }}</strong>
								{% endif %}
								{% if news_item.timestamp %}
									<div class="news-timestamp">
										<small>–î–∞—Ç–∞ –ø—É–±–ª—ñ–∫–∞—Ü—ñ—ó: {{ news_item.timestamp }}</small>
									</div>
								{% endif %}
								{% if news_item.description %}
									<p class="news-description">{{ news_item.description | safe }}</p>
								{% endif %}
								{% if news_item.footer %}
									<div class="news-footer">{{ news_item.footer }}</div>
								{% endif %}

								{% if news_item.reactions %}
									<div class="reactions">
										{% for reaction in news_item.reactions %}
											<button class="reaction-button">{{ reaction.emoji }} {{ reaction.count }}</button>
										{% endfor %}
									</div>
								{% endif %}

								{% if news_item.message_link %}
									<div style="text-align: right;">
									<!--	<a href="{{ news_item.message_link }}" class="news-link" target="_blank">–î–µ—Ç–∞–ª—å–Ω—ñ—à–µ</a> -->
									</div>
								{% endif %}

								{% if news_item.comments %}
									<div class="comments">
										<h4>–ö–æ–º–µ–Ω—Ç–∞—Ä—ñ:</h4>
										{% for comment in news_item.comments %}
											<div class="comment"><strong>{{ comment.author.global_name }}</strong>: {{ comment.content }}</div>
										{% endfor %}
									</div>
								{% else %}
									<div class="comments"><p>–ù–µ–º–∞—î –∫–æ–º–µ–Ω—Ç–∞—Ä—ñ–≤.</p></div>
								{% endif %}
							</div>
						</div>
					{% endfor %}
				{% else %}
					<p>–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –Ω–æ–≤–∏–Ω–∏.</p>
				{% endif %}
			</div>
		</div>
		<div class="login-panel"><br>
			<img src="/static/logo.png" width="100px" /><br>
			<h1>–í—Ö—ñ–¥</h1>
			<form method="post">
				<label for="nickname">–í–∞—à –Ω—ñ–∫–Ω–µ–π–º:</label>
				<input type="text" id="nickname" class="input" placeholder="Joseph" name="nickname" 
					{% if data and data.nickname %} value="{{ data.nickname }}" {% endif %}><br>
				<details>
					<summary>–ü–∞—Ä–∞–º–µ—Ç—Ä–∏</summary>
					<div class="settings">
						<label for="loader">–ó–∞–≤–∞–Ω—Ç–∞–∂—É–≤–∞—á:</label>
						<select name="loader" class="input" id="loader">
							<option value="fabric-loader-0.16.14-1.21.1" {% if data and data.loader == 'fabric-loader-0.16.14-1.21.1' %} selected {% endif %}>Fabric</option>
						<!--	<option value="forge" {% if data and data.loader == 'forge' %} selected {% endif %}>Forge</option> -->
							<option value="1.21.1" {% if data and data.loader == '1.21.1' %} selected {% endif %}>Vanilla</option>
						</select><br>
						<label for="ram">–û–ø–µ—Ä–∞—Ç–∏–≤–Ω–∞ –ø–∞–º'—è—Ç—å:</label>
						<select name="ram" class="input" id="ram">
							<option value="2G" {% if data and data.ram == '2G' %} selected {% endif %}>2GB</option>
							<option value="4G" {% if data and data.ram == '4G' %} selected {% endif %}>4GB</option>
							<option value="8G" {% if data and data.ram == '8G' %} selected {% endif %}>8GB</option>
						</select><br>
						<label for="windowSize">–†–æ–∑–º—ñ—Ä –≤—ñ–∫–Ω–∞:</label>
						<select name="windowSize" class="input" id="windowSize">
							<option value="1280x720" {% if data and data.windowSize == '1280x720' %} selected {% endif %}>1280x720</option>
							<option value="1920x1080" {% if data and data.windowSize == '1920x1080' %} selected {% endif %}>1920x1080</option>
						</select><br>
						<div>
							<label for="multiplayer">–í—Ö—ñ–¥ –Ω–∞ —Å–µ—Ä–≤–µ—Ä:
							<input type="checkbox" id="multiplayer" name="multiplayer"
								{% if data and data|length > 0 %}
									{% if data.multiplayer == true %}
										checked
									{% endif %}
								{% else %}
									checked
								{% endif %}></label>
						</div>
						<div>
							<label for="console">–ö–æ–Ω—Å–æ–ª—å:
							<input type="checkbox" id="console" name="console"
								{% if data and data|length > 0 %}
									{% if data.console == true %}
										checked
									{% endif %}
								{% else %}
									checked
								{% endif %}></label>
						</div>
						<div>
						<!--	<label for="fullscreen">–ü–æ–≤–Ω–æ–µ–∫—Ä–∞–Ω–Ω–∏–π —Ä–µ–∂–∏–º:</label>
							<input type="checkbox" id="fullscreen" name="fullscreen" 
								{% if data and data.fullscreen %} checked {% endif %}> -->
						</div>
						<div>
							<a href="#" onclick="openGameFolder()">üìÇ –ü–∞–ø–∫–∞ –≥—Ä–∏</a>
						</div><br>
					</div><br>
				</details>
				<div id="log-box" style="padding: 10px;">
					<div id="logs"></div>
				</div>
				<button type="submit" class="button" id="start" formaction="/start">–î–æ –≥—Ä–∏ ‚öîÔ∏è</button>
				
				{% if is_latest_version == False %}
					<div id="update">–î–æ—Å—Ç—É–ø–Ω–∞ –Ω–æ–≤–∞ –≤–µ—Ä—Å—ñ—è –ª–∞—É–Ω—á–µ—Ä–∞! –ë—É–¥—å –ª–∞—Å–∫–∞, –∑–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ —ó—ó <u><a href="#" onclick="fetch('/update')">—Ç—É—Ç</a></u></div>
				{% endif %}
				
			</form>
		</div>
	</div>
	<script>
		let loading = false;
		let gameRunning = false;

		function appendLog(message) {
			const logs = document.getElementById("logs");
			const entry = document.createElement("div");
			logs.innerHTML = '';
			entry.textContent = message;

			if (loading) {
				const span = document.createElement("span");
				span.className = "loading-dots";
				entry.appendChild(span);
			}

			logs.appendChild(entry);
			logs.scrollTop = logs.scrollHeight;
		}

		function setLoading(state) {
			loading = state;
			const startButton = document.getElementById("start");
			
			if (state) {
				startButton.disabled = true;
				startButton.textContent = "–ó–∞–ø—É—Å–∫...";
			} else if (!gameRunning) {
				startButton.disabled = false;
				startButton.textContent = "–î–æ –≥—Ä–∏ ‚öîÔ∏è";
			}

			const oldDots = document.querySelectorAll(".loading-dots");
			oldDots.forEach(dot => dot.remove());

			if (loading) {
				const logs = document.getElementById("logs");
				const last = logs.lastElementChild;
				if (last) {
					const span = document.createElement("span");
					span.className = "loading-dots";
					last.appendChild(span);
				}
			}
		}

		function setGameRunning(state) {
			gameRunning = state;
			const startButton = document.getElementById("start");
			
			if (state) {
				startButton.disabled = true;
				startButton.textContent = "–ó–∞–ø—É—Å–∫...";
			} else {
				startButton.disabled = false;
				startButton.textContent = "–î–æ –≥—Ä–∏ ‚öîÔ∏è";
			}
		}
		
		function openGameFolder() {
			const form = document.querySelector("form");
			const formData = new FormData(form);

			fetch('/game_folder', {
				method: 'POST',
				body: formData
			})
			.then(res => res.json())
			.then(data => {
				if (data.success) {
					console.log("–ü–∞–ø–∫—É –≤—ñ–¥–∫—Ä–∏—Ç–æ");
				} else {
					console.error(data.error);
					alert("‚ùå " + data.error);
				}
			})
			.catch(err => {
				console.error("Fetch error:", err);
				alert("‚ö†Ô∏è –ù–µ –≤–¥–∞–ª–æ—Å—è –Ω–∞–¥—ñ—Å–ª–∞—Ç–∏ –∑–∞–ø–∏—Ç");
			});
		}

		$(document).ready(function () {
			document.addEventListener('contextmenu', event => event.preventDefault());

			$('#start').click(function (event) {
				event.preventDefault();
				
				if (this.disabled) {
					console.log('–ö–Ω–æ–ø–∫–∞ –≤—ñ–¥–∫–ª—é—á–µ–Ω–∞, –∫–ª—ñ–∫ —ñ–≥–Ω–æ—Ä—É—î—Ç—å—Å—è');
					return false;
				}
				
				const payload = {
					nickname: $('#nickname').val(),
					ram: $('#ram').val(),
					loader: $('#loader').val(),
					windowSize: $('#windowSize').val(),
					multiplayer: $('#multiplayer').is(':checked'),
					fullscreen: $('#fullscreen').is(':checked'),
					console: $('#console').is(':checked')
				};

				setLoading(true);
				
				fetch('/start', {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify(payload)
				})
				.then(response => response.json())
				.then(data => {
					if (data.success) {
						setGameRunning(true);
						appendLog("");
					} else {
						setLoading(false);
						appendLog(`${data.error}`);
					}
				})
				.catch(error => {
					setLoading(false);
					appendLog(`–í–∏–Ω–∏–∫–ª–∞ –ø–æ–º–∏–ª–∫–∞: ${error.message}`);
				});
			});
		});
		
		const logsDiv = document.getElementById("logs");
		const socket = new WebSocket("ws://127.0.0.1:5263");

		socket.onmessage = function (event) {
			const message = event.data;
			appendLog(message);
			
			// –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ –≥—Ä–∞ –∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—å
			if (message.includes("–ì—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞") || message.includes("–ü—Ä–æ—Ü–µ—Å –∑–∞–≤–µ—Ä—à–µ–Ω–æ")) {
				setGameRunning(false);
				setLoading(false);
			}
		};

		socket.onopen = function () {
			console.log("–ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ –≤–µ–±—Å–æ–∫–µ—Ç—ñ–≤ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ.");
		};

		socket.onclose = function () {
			console.log("–ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ –≤–µ–±—Å–æ–∫–µ—Ç—ñ–≤ –∑–∞–∫—Ä–∏—Ç–æ.");
		};

		socket.onerror = function (error) {
			console.error("–ü–æ–º–∏–ª–∫–∞ –≤–µ–±—Å–æ–∫–µ—Ç—ñ–≤:", error);
		};
		
	</script>
</body>
</html>